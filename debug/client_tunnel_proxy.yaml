admin:
  address:
    socket_address:
      protocol: TCP
      address: 127.0.0.1
      port_value: 9901
static_resources:
  listeners:
  # TODO: add 15001 back. Each per svc listener should set bind_to_port to false
  # TODO: add more outbound svc
  - name: outbound_tcp_svc_19000 # missing listener 15001, so the client app must specify the envoy listening port
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 19000
    filter_chains:
    - filter_chain_match:
      filters:
      - name: tcp_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
          stat_prefix: remote_outbound_19000
          cluster: remote_outbound_cluster_19000
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: "/dev/stdout"
              log_format:
                text_format_source:
                  inline_string: "tcpsvc19000 %DOWNSTREAM_REMOTE_ADDRESS%--%DOWNSTREAM_LOCAL_ADDRESS%\n"

  - name: singleton_internal_encap
    address:
      envoy_internal_address:
        server_listener_name: singleton_internal_encap
    filter_chains:
    - filters:
      - name: tcp_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
          stat_prefix: singleton_internal_encap
          cluster: singleton_internal_encap
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: "/dev/stdout"
              log_format:
                text_format_source:
                  inline_string: 'encap_outbound %DOWNSTREAM_REMOTE_ADDRESS%--%DOWNSTREAM_LOCAL_ADDRESS%'
          tunneling_config:
            hostname: host.com:443
            headers_to_add:
            - header:
                key: original_port
                value: "%DOWNSTREAM_LOCAL_PORT%"
            - header:
                key: original_ip
                value: "%DOWNSTREAM_LOCAL_ADDRESS_WITHOUT_PORT%"
            - header:
                key: original_address
                value: "%DOWNSTREAM_LOCAL_ADDRESS%"
    use_original_dst: false
    internal_listener: {}


  clusters:
  # per svc cluster in prod the cluster type is EDS. We use STATIC in POC.
  - name: remote_outbound_cluster_19000
    connect_timeout: 3600s
    type: STATIC
    # Comment out the following line to test on v6 networks
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: remote_outbound_cluster_19000
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 9000
    transport_socket:
      name: envoy.transport_sockets.internal_redirect
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.internal_tunnel.v3.InternalTunnelConfig
        target_internal_listener:
          server_listener_name: singleton_internal_encap
  
  - name: singleton_internal_encap
    connect_timeout: 10s
    type: ORIGINAL_DST
    lb_policy: CLUSTER_PROVIDED
    cleanup_interval: 60s
layered_runtime:
  layers:
  - name: hbone_exp
    static_layer:
      envoy.reloadable_features.internal_address: true
#  - name: deprecation
#    static_layer:
  - name: global config
    static_layer:
      overload.global_downstream_max_connections: 2147483647
  - name: admin
    admin_layer: {}
